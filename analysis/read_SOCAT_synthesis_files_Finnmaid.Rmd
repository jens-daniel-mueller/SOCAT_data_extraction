---
title: "Read synthesis files"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r libraries}

library(tidyverse)

```


# Set path

```{r set_path}

path_SOCAT <- "/nfs/kryo/work/updata/SOCAT/"
print(path_SOCAT)

```


# Read files

```{r read_files}

file_all <- "SOCATv2021.tsv"
file_FlagE <- "SOCATv2021_FlagE.tsv"


# Finnmaid DOI subset -----------------------------------------------------

meta <- read_delim(
  file = paste0(path_SOCAT, file_all),
  "\t",
  escape_double = FALSE,
  trim_ws = TRUE,
  skip = 4,
  n_max = 6564
)

meta <- meta %>%
  filter(`Platform Name` %in% c("Finnmaid", "VOS Finnpartner"))

Finnmaid_Expocode <- meta$Expocode

f <-
  function(x, pos) subset(x, Expocode %in% Finnmaid_Expocode)

df_Expocode_all <-
  read_tsv_chunked(
    file = paste0(path_SOCAT, file_all),
    skip = 6623,
    DataFrameCallback$new(f),
    chunk_size = 100000
  )

rm(f, meta, Finnmaid_Expocode_all)

# Finnmaid Flag E DOI subset ----------------------------------------------

meta <- read_delim(
  file = paste0(path_SOCAT, file_FlagE),
  "\t",
  escape_double = FALSE,
  trim_ws = TRUE,
  skip = 4,
  n_max = 194
)

meta <- meta %>%
  filter(`Platform Name` %in% c("Finnmaid", "VOS Finnpartner"))

Finnmaid_Expocode <- meta$Expocode

f <-
  function(x, pos) subset(x, Expocode %in% Finnmaid_Expocode)

df_Expocode_E <-
  read_tsv_chunked(
    file = paste0(path_SOCAT, file_FlagE),
    skip = 251,
    DataFrameCallback$new(f),
    chunk_size = 100000
  )

rm(f, meta, Finnmaid_Expocode)

# Merge Central Baltic Sea and DOI data set -------------------------------

df <-
  bind_rows(df_Expocode_all %>% mutate(across(yr:ss, as.character)),
            df_Expocode_E %>% mutate(across(yr:ss, as.character)))

df <- df %>% 
  rename("lon" = "longitude [dec.deg.E]",
         "lat" = "latitude [dec.deg.N]",
         "fCO2" = "fCO2rec [uatm]",
         "SST" = "SST [deg.C]") %>% 
  mutate(date_time = lubridate::ymd_hms(paste(yr, mon, day, hh, mm, ss))) %>% 
  select(date_time, yr, mon, lon, lat, sal, SST, fCO2)



df %>% 
  filter(lat > 59, lat < 59.05) %>% 
  ggplot(aes(date_time, fCO2, col=SST))+
  geom_point()+
  scale_color_viridis_c()+
  labs(x="", y="fCO2", title = "Finnpartner / Finnmaid data",
      subtitle = "Subsets from SOCATv2021 incl Flag E  | Lat range: 59-59.05N")+
  theme_bw()



```

# Identify cruises

```{r cruise_identification}

# time_lag_limit <- 60*60*10

for (time_lag_limit in seq(0.2, 20, 0.1)*60^2) {
  
  print(time_lag_limit/60^2)
  
  df <- df %>%
  arrange(date_time) %>%
  mutate(cruise = cumsum(c(TRUE, diff(date_time) >= time_lag_limit)))
  
  cruise_duration <- df %>% 
    group_by(cruise) %>% 
    summarise(cruise_duration = 
                as.numeric(difftime(max(date_time), min(date_time), units = "hours"))) %>% 
    summarise(min_duration = min(cruise_duration),
              max_duration = max(cruise_duration))

  cruise_counts_temp <- bind_cols( 
  time_lag_limit = time_lag_limit/60^2,
  n_cruises = max(df$cruise)
  )
  
  cruise_counts_temp <- bind_cols(
    cruise_counts_temp,
    cruise_duration
  )
  
  if (exists("cruise_counts")) {
    cruise_counts <- bind_rows(cruise_counts, cruise_counts_temp)
  }
  
  if (!exists("cruise_counts")) {
    cruise_counts <- cruise_counts_temp
  }

  
}

cruise_counts %>% 
  ggplot(aes(time_lag_limit, n_cruises)) +
  geom_path() +
  geom_point()

cruise_counts %>% 
  ggplot(aes(time_lag_limit, max_duration)) +
  geom_path() +
  geom_point() +
  coord_cartesian(ylim = c(0,100))

cruise_counts %>%
  ggplot(aes(time_lag_limit, min_duration)) +
  geom_path() +
  geom_point() +
  coord_cartesian(ylim = c(0, 1))

rm(cruise_counts, cruise_counts_temp, cruise_duration)


for (time_lag_limit in seq(2, 8, 2)*60^2) {
  
  print(time_lag_limit/60^2)
  
  df <- df %>%
  arrange(date_time) %>%
  mutate(cruise = cumsum(c(TRUE, diff(date_time) >= time_lag_limit)))
  
  cruise_duration <- df %>% 
    group_by(cruise) %>% 
    summarise(cruise_duration = 
                as.numeric(difftime(max(date_time), min(date_time), units = "hours")))

  cruise_counts_temp <- bind_cols( 
  time_lag_limit = time_lag_limit/60^2,
  n_cruises = max(df$cruise)
  )
  
  cruise_counts_temp <- bind_cols(
    cruise_counts_temp,
    cruise_duration
  )
  
  if (exists("cruise_counts")) {
    cruise_counts <- bind_rows(cruise_counts, cruise_counts_temp)
  }
  
  if (!exists("cruise_counts")) {
    cruise_counts <- cruise_counts_temp
  }

  
}



cruise_counts %>% 
  ggplot(aes(as.factor(time_lag_limit), cruise_duration)) +
  geom_violin()


time_lag_limit <- 5*60^2

df <- df %>%
  arrange(date_time) %>%
  mutate(cruise = cumsum(c(TRUE, diff(date_time) >= time_lag_limit)))

cruise_duration <- df %>%
  group_by(cruise) %>%
  summarise(cruise_duration =
              as.numeric(difftime(max(date_time), min(date_time), units = "hours")))

df <- df %>%
  group_by(cruise) %>%
  mutate(cruise_duration =
              as.numeric(difftime(max(date_time), min(date_time), units = "hours")))


cruise_duration %>% 
  ggplot(aes(cruise_duration)) +
  geom_histogram()

df %>% 
  ggplot(aes(cruise_duration)) +
  geom_histogram()

df %>% filter(cruise_duration < 10) %>% 
  count(cruise)

df <- df %>% 
  filter(cruise_duration >= 10) %>% 
  select(cruise, date_time, yr, mon, lon, lat, sal, SST, fCO2)

```


# Write summary file


```{r write_file}


# Safe merged data file ---------------------------------------------------

df %>%
  write_csv(paste0(path_SOCAT, "SOCATv2021_Baltic_Finnmaid.csv"))


```

